import { test, expect, describe } from "vitest";

import { BufferTokenizer } from "../../../strtok3/BufferTokenizer";
import { u8 } from "../../primitive/integer";
import { readUnitFromTokenizer } from "../../utility/read-unit";
import { extendedContentDescriptionObject } from "../extended-content-description";

import type { ITag } from "../../../type";

describe("unit size: content description object", () => {
  test("content description object", () => {
    const [size] = extendedContentDescriptionObject(50);

    expect(size).toBe(50);
  });
});

type Case = [description: string, source: number[], expected: ITag[]];
const cases: Case[] = [
  [
    "parse content description object",
    [
      // content descriptor count
      0x05, 0x00,
      // string content
      0x0a, 0x00, 0x54, 0x00, 0x69, 0x00, 0x74, 0x00, 0x6c, 0x00, 0x65, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x54, 0x00, 0x49,
      0x00, 0x54, 0x00, 0x4c, 0x00, 0x45, 0x00,
      // buffer content
      0x0c, 0x00, 0x42, 0x00, 0x75, 0x00, 0x66, 0x00, 0x66, 0x00, 0x65, 0x00, 0x72, 0x00, 0x01, 0x00, 0x0a, 0x00, 0x01,
      0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a,
      // boolean content
      0x08, 0x00, 0x42, 0x00, 0x6f, 0x00, 0x6f, 0x00, 0x6c, 0x00, 0x02, 0x00, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00,
      // 32bit int content
      0x08, 0x00, 0x57, 0x00, 0x6f, 0x00, 0x72, 0x00, 0x64, 0x00, 0x03, 0x00, 0x04, 0x00, 0x12, 0x00, 0x23, 0x00,
      // WM/Picture content
      0x14, 0x00, 0x57, 0x00, 0x4d, 0x00, 0x2f, 0x00, 0x50, 0x00, 0x69, 0x00, 0x63, 0x00, 0x74, 0x00, 0x75, 0x00, 0x72,
      0x00, 0x65, 0x00, 0x01, 0x00, 0x21, 0x00, 0x01, 0x80, 0x00, 0x10, 0x00, 0x6a, 0x00, 0x70, 0x00, 0x65, 0x00, 0x67,
      0x00, 0x00, 0x00, 0x69, 0x00, 0x6d, 0x00, 0x61, 0x00, 0x67, 0x00, 0x65, 0x00, 0x00, 0x00, 0xff, 0xee, 0xdd, 0xcc,
      0xbb, 0xaa,
    ],
    [
      { id: "Title", value: "TITLE" },
      { id: "Buffer", value: new Uint8Array([0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a]) },
      { id: "Bool", value: true },
      { id: "Word", value: 0x00_23_00_12 },
      {
        id: "WM/Picture",
        value: {
          type: "32x32 pixels 'file icon' (PNG only)",
          format: "jpeg",
          description: "image",
          size: 0x00_10_00_80,
          data: new Uint8Array([0xff, 0xee, 0xdd, 0xcc, 0xbb, 0xaa]),
        },
      },
    ],
  ],
];

describe("unit: content description object", () => {
  test.each(cases)("%s", async (_, bytes, expected) => {
    const buffer = new Uint8Array(bytes);
    const tokenizer = new BufferTokenizer(buffer);
    const result = readUnitFromTokenizer(tokenizer, extendedContentDescriptionObject(buffer.length));

    await expect(result).resolves.toEqual(expected);

    // all bytes are read
    await expect(readUnitFromTokenizer(tokenizer, u8)).rejects.toThrow();
  });
});
